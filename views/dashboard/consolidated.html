{% extends 'layout.html' %}

{% block head %}

<title>Consolidated e-Invoices - eInvoice Portal</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link href="/assets/css/pages/inbound/card.css" rel="stylesheet">
<link href="/assets/css/pages/inbound/notice.css" rel="stylesheet">
<link href="/assets/css/pages/inbound/validation-modal.css" rel="stylesheet">
<link href="/assets/css/pages/inbound/inbound-modal.css" rel="stylesheet">
<!-- Template Main CSS Files -->
<link href="/assets/css/pages/outbound/outbound-table.css" rel="stylesheet">
<link href="/assets/css/pages/outbound/consolidation.css" rel="stylesheet">
<link href="/assets/css/pages/outbound/manual-consolidation.css" rel="stylesheet">

{% endblock %}

{% block content %}

<!-- Main Content Area -->
<main class="dashboard consolidation-dashboard">
  <div class="container-fluid px-lg-4 py-4">
    <!-- Page Header -->
    <div class="row mb-4">
      <div class="col">
        <div class="d-flex align-items-center">
          <h1 class="dashboard-title mb-0">Consolidated e-Invoices</h1>
          <div class="ms-auto d-flex">
            <button id="openFlatFileModalBtn" class="btn btn-primary me-2">
              <i class="bi bi-upload me-1"></i>Upload Flat File
            </button>
            <button id="createManualConsolidationBtn" class="btn btn-outline-primary">
              <i class="bi bi-plus-circle me-1"></i>Create Manual Entry
            </button>
          </div>
        </div>
        <p class="text-muted fs-6 mb-0 mt-1">Manage and submit consolidated e-Invoices for B2C transactions to LHDN</p>
      </div>
    </div>

    <!-- Info Card -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card notice-card bg-light border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex">
              <div class="flex-shrink-0">
                <i class="bi bi-info-circle text-primary fs-4"></i>
              </div>
              <div class="flex-grow-1 ms-3">
                <h5 class="card-title">Consolidated e-Invoicing Guidelines</h5>
                <p class="card-text">For B2C transactions where buyers don't require individual e-invoices, you can submit a consolidated e-invoice to LHDN by:</p>
                <ul>
                  <li>Uploading a flat file with all transactions for a specific period</li>
                  <li>Manually creating a consolidated entry for your invoices</li>
                  <li>Submitting within 7 calendar days after the end of each month</li>
                </ul>
                <p class="mb-0"><strong>Note:</strong> For consolidated invoices, buyer information must use "General Public" as the name and "EI00000000010" as the TIN.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
      <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
        <div class="card stats-card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-light-primary rounded-3">
                <i class="bi bi-file-earmark-text text-primary"></i>
              </div>
              <div class="ms-3">
                <h6 class="card-title text-muted mb-0">Total Consolidated</h6>
                <h3 class="mt-2 mb-0 total-count" id="totalConsolidated">0</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
        <div class="card stats-card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-light-success rounded-3">
                <i class="bi bi-check-circle text-success"></i>
              </div>
              <div class="ms-3">
                <h6 class="card-title text-muted mb-0">Successfully Submitted</h6>
                <h3 class="mt-2 mb-0 pending-count" id="successfullySubmitted">0</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
        <div class="card stats-card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-light-warning rounded-3">
                <i class="bi bi-hourglass-split text-warning"></i>
              </div>
              <div class="ms-3">
                <h6 class="card-title text-muted mb-0">Pending Submission</h6>
                <h3 class="mt-2 mb-0 processing-count" id="pendingSubmission">0</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="card stats-card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="stat-icon bg-light-danger rounded-3">
                <i class="bi bi-exclamation-triangle text-danger"></i>
              </div>
              <div class="ms-3">
                <h6 class="card-title text-muted mb-0">Failed Submissions</h6>
                <h3 class="mt-2 mb-0 rejected-count" id="failedSubmissions">0</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Consolidated Invoices Table -->
    <div class="row">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white py-3">
            <div class="d-flex align-items-center">
              <h5 class="card-title mb-0">Consolidated e-Invoices</h5>
              <div class="ms-auto d-flex">
                <div class="input-group me-2" style="width: 250px;">
                  <input type="text" class="form-control" id="quickSearch" placeholder="Search invoices...">
                  <button class="btn btn-outline-secondary" type="button" id="quickSearchBtn">
                    <i class="bi bi-search"></i>
                  </button>
                </div>
                <div class="dropdown">
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="filterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-funnel me-1"></i>Filters
                  </button>
                  <div class="dropdown-menu p-3" aria-labelledby="filterDropdown" style="width: 300px;">
                    <h6 class="dropdown-header">Filter e-Invoices</h6>
                    <div class="mb-3">
                      <label class="form-label">Status</label>
                      <select class="form-select form-select-sm" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Submitted">Submitted</option>
                        <option value="Failed">Failed</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Date Range</label>
                      <div class="d-flex">
                        <input type="date" class="form-control form-control-sm me-2" id="startDateFilter">
                        <input type="date" class="form-control form-control-sm" id="endDateFilter">
                      </div>
                    </div>
                    <div class="d-flex justify-content-end">
                      <button class="btn btn-sm btn-outline-secondary me-2" id="clearFiltersBtn">Clear</button>
                      <button class="btn btn-sm btn-primary" id="applyFiltersBtn">Apply</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="activeFilters" class="d-flex flex-wrap mt-2" style="display: none !important;"></div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0" id="consolidatedTable">
                <thead class="table-light">
                  <tr>
                    <th>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                      </div>
                    </th>
                    <th>Invoice No</th>
                    <th>Period</th>
                    <th>Transactions</th>
                    <th>Total Amount</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="consolidatedTableBody">
                  <!-- Table content will be loaded dynamically -->
                </tbody>
              </table>
            </div>
            <div id="emptyState" class="text-center py-5">
              <img src="/assets/img/illustrations/empty-invoices.svg" alt="No invoices" class="img-fluid mb-3" style="max-width: 200px;">
              <h5>No consolidated invoices found</h5>
              <p class="text-muted">Upload a flat file or create a manual entry to get started</p>
              <div class="mt-3">
                <button class="btn btn-primary btn-sm me-2" id="emptyStateUploadBtn">
                  <i class="bi bi-upload me-1"></i>Upload Flat File
                </button>
                <button class="btn btn-outline-primary btn-sm" id="emptyStateCreateBtn">
                  <i class="bi bi-plus-circle me-1"></i>Create Manual Entry
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Flat File Upload Modal -->
<div class="modal fade" id="flatFileUploadModal" tabindex="-1" aria-labelledby="flatFileUploadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="flatFileUploadModalLabel">Upload Consolidated Invoice Flat File</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <p>Upload a CSV file containing your consolidated invoice data. The file should follow the required format.</p>
          <p class="small text-muted">
            <i class="bi bi-info-circle"></i> For consolidated e-invoices, the buyer must be "General Public" with TIN "EI00000000010".
          </p>
        </div>
        
        <input type="file" id="flatFileUpload" class="d-none" accept=".csv,.txt">
        
        <div id="uploadArea" class="upload-area border rounded p-4 text-center">
          <i class="bi bi-cloud-upload fs-2 mb-2 text-primary"></i>
          <p class="mb-3">Drag and drop your file here, or</p>
          <a href="#" id="browseFilesLink" class="btn btn-outline-primary btn-sm">Browse Files</a>
        </div>
        
        <div id="fileDetails" class="mt-3 d-none">
          <div class="d-flex align-items-center">
            <i class="bi bi-file-earmark-text fs-4 text-primary me-2"></i>
            <div class="flex-grow-1">
              <h6 class="mb-0 file-name">filename.csv</h6>
              <p class="small text-muted mb-0 file-info">Size: 0 KB</p>
            </div>
            <button id="removeFile" class="btn btn-sm btn-outline-danger">
              <i class="bi bi-x"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <!-- Download template button will be inserted here via JS -->
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

            <!-- Table Section -->
            <div class="table-container-wrapper">
                <div class="table-card">
                    <div class="table-header">
                        <div class="table-header-content">
                            <h2 class="table-title">Consolidated Document List</h2>
                            <div class="table-actions">
                                <!-- <button id="exportSelected" class="btn outbound-action-btn submit btn-sm ms-1" disabled>
                                    <i class="bi bi-download me-2"></i>Export Selected
                                </button> -->
                            </div>
                        </div>              
                    </div>
                    <div class="table-controls">
                        <div class="d-flex align-items-center gap-1">
                            <div class="modern-length">
                                <!-- Length control will be inserted by DataTables -->
                            </div>
                            <div class="modern-search">
                                <!-- Search control will be inserted by DataTables -->
                            </div>
                        </div>
                    </div>
                    <div class="table-body-container">
                        <div class="responsive-table-container">
                            <div class="table-section">
                                <div class="outbound-table-container">
               
                                    <div>
                                        <!-- Primary Filters Row -->
                                        <div class="row g-3 mb-3">
                                            <!-- Global Search -->
                                            <div class="col-md-4">
                                                <div class="search-wrapper position-relative">
                                                    <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                                                    <input type="text" class="form-control form-control-lg ps-5" id="globalSearch" 
                                                        placeholder="Search documents...">
                                                </div>
                                            </div>
                                            
                                            <!-- Quick Filters -->
                                            <div class="col-md-8">
                                                <div class="quick-filters d-flex gap-2">
                                                    <!-- <button class="btn outbound-action-btn submit" data-bs-toggle="modal" data-bs-target="#consolidatedSubmitModal">
                                                        <i class="bi bi-file-earmark-arrow-up me-1"></i>Bulk Submit
                                                    </button> -->
                                                    <button class="btn outbound-action-btn submit" data-filter="all">
                                                        <i class="bi bi-grid-3x3-gap-fill me-1"></i>All
                                                    </button>
                                          
                                                    <button class="btn outbound-action-btn submit active" data-filter="pending">
                                                        <i class="bi bi-clock-history me-1"></i>Pending
                                                    </button>
                                                    <button class="btn outbound-action-btn submit" id="openFlatFileModalBtn" data-bs-toggle="modal" data-bs-target="#flatFileUploadModal" title="If you don't have custom integration, you can upload your own flat file">
                                                        <i class="bi bi-file-earmark-text me-1"></i>Upload File
                                                    </button>
                                                    <!-- <button class="btn outbound-action-btn submit" data-filter="submitted">
                                                        <i class="bi bi-check-circle me-1 text-success"></i>Submitted
                                                    </button>
                                                    <button class="btn outbound-action-btn submit" data-filter="invalid">
                                                        <i class="bi bi-x-circle me-1 text-danger"></i>Invalid
                                                    </button>
                                                    
                                                    <button class="btn outbound-action-btn submit" data-filter="cancelled">
                                                        <i class="bi bi-exclamation-triangle-fill me-1 text-warning"></i>Cancelled
                                                    </button>
                                                    <button class="btn outbound-action-btn submit" data-filter="pending">
                                                        <i class="bi bi-clock-history me-1 text-warning"></i>Pending
                                                    </button> -->
                                                    <!-- <div class="ms-auto">
                                                        <button class="btn outbound-action-btn cancel" id="clearFilters" data-bs-toggle="tooltip" title="Clear all filters">
                                                            <i class="bi bi-eraser me-1"></i>Clear
                                                        </button>
                                                        <button class="btn outbound-action-btn submit" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                                                            <i class="bi bi-sliders me-1"></i>Advanced
                                                        </button>
                                                    </div> -->
                                                </div>
                                            </div>
                                        </div>
                    
                                        <!-- Advanced Filters (Collapsible) -->
                                        <div class="collapse" id="advancedFilters">
                                            <div class="advanced-filters-content border-top pt-3">
                                                <div class="row g-3">
                                                    <!-- Date Range -->
                                                    <div class="col-md-6">
                                                        <label class="form-label d-flex align-items-center">
                                                            <i class="bi bi-calendar-range me-2"></i>Date Range
                                                        </label>
                                                        <div class="input-group">
                                                            <input type="date" class="form-control" id="tableStartDate">
                                                            <span class="input-group-text bg-light">to</span>
                                                            <input type="date" class="form-control" id="tableEndDate">
                                                        </div>
                                                    </div>
                    
                                                    <!-- Amount Range -->
                                                    <div class="col-md-6">
                                                        <label class="form-label d-flex align-items-center">
                                                            <i class="bi bi-currency-dollar me-2"></i>Amount Range
                                                        </label>
                                                        <div class="input-group">
                                                            <input type="number" class="form-control" id="minAmount" placeholder="Min">
                                                            <span class="input-group-text bg-light">to</span>
                                                            <input type="number" class="form-control" id="maxAmount" placeholder="Max">
                                                        </div>
                                                    </div>
                    
                                                    <!-- Company Filter -->
                                                    <div class="col-md-4">
                                                        <label class="form-label d-flex align-items-center">
                                                            <i class="bi bi-building me-2"></i>Company
                                                        </label>
                                                        <input type="text" class="form-control" id="companyFilter" placeholder="Filter by company name">
                                                    </div>
                    
                                                    <!-- Document Type -->
                                                    <div class="col-md-4">
                                                        <label class="form-label d-flex align-items-center">
                                                            <i class="bi bi-file-text me-2"></i>Document Type
                                                        </label>
                                                        <select class="form-select" id="documentTypeFilter">
                                                            <option value="">All Types</option>
                                                            <option value="Invoice">Invoice</option>
                                                            <option value="Credit Note">Credit Note</option>
                                                            <option value="Debit Note">Debit Note</option>
                                                        </select>
                                                    </div>
                    
                                                    <!-- Source -->
                                                    <div class="col-md-4">
                                                        <label class="form-label d-flex align-items-center">
                                                            <i class="bi bi-diagram-2 me-2"></i>Source
                                                            <i class="bi bi-info-circle ms-2" data-bs-html="true" 
                                                            title="<div class='tooltip-content'>
                                                                    <div class='tooltip-row'>
                                                                        <i class='bi bi-info-circle'></i>
                                                                        <span><b>LHDN Validation:</b></span>
                                                                    </div>
                                                                    <div class='tooltip-row'>
                                                                        <i class='bi bi-check-circle text-success'></i>
                                                                        <span>Valid: Document passed validation</span>
                                                                    </div>
                                                                    <div class='tooltip-row'>
                                                                        <i class='bi bi-x-circle text-danger'></i>
                                                                        <span>Invalid: Failed validation checks</span>
                                                                    </div>
                                                                    <div class='tooltip-row'>
                                                                        <i class='bi bi-clock-history text-warning'></i>
                                                                        <span>Pending: Awaiting for Submission to LHDN for validation</span>
                                                                    </div>
                                                                </div>"></i>
                                                        </label>
                                                        <select class="form-select" id="sourceFilter">
                                                            <option value="">LHDN</option>
                                                            
                                                        </select>
                                                        <small class="text-muted mt-1 d-block">
                                                            <i class="bi bi-info-circle-fill me-1"></i>
                                                            LHDN responses include validation status and timestamps
                                                        </small>
                                                    </div>
                                                </div>
                    
                                            
                                                <!-- Filter Note -->
                                                <div class="filter-note alert alert-info mt-3" role="alert">
                                                    <i class="bi bi-info-circle me-2"></i>
                                                    <small>
                                                        Use the filters above to narrow down your results. Active filters will appear below as tags that you can easily remove. Click the 'x' on any tag to remove that filter, or use 'Clear all filters' to reset.
                                                    </small>
                                                </div>
                    
                                                <!-- Active Filters Display -->
                                                <div class="active-filters mt-3 pt-3 border-top">
                                                    <div class="d-flex align-items-center">
                                                        <small class="text-muted me-2">Active Filters:</small>
                                                        <div class="active-filter-tags" id="activeFilterTags">
                                                            <!-- Active filter tags will be added here dynamically -->
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                      
                                    </div>
                                    <!-- End of new filter section -->
                                  
                    
                                        <table id="invoiceTable" class="outbound-table-responsive">
                                            <thead>
                                                <tr>
                                                    <th class="outbound-checkbox-column">
                                                        <div class="outbound-checkbox-header">
                                                            <input type="checkbox" class="outbound-checkbox" id="selectAll">
                                                        </div>
                                                    </th>
                                                    <th>#</th>
                                                    <th>INVOICE NO.</th>
                                                    <th>COMPANY</th>
                                                    <th>SUPPLIER</th>
                                                    <th>RECEIVER</th>
                                                    <th>DATE</th>
                                                    <th>INV. DATE INFO</th>
                                                    <th>STATUS</th>
                                                    <th>SOURCE</th>
                                                    <th>TOTAL AMOUNT</th>
                                                    <th class="outbound-action-column">ACTION</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Example row with TIN validation button -->
                                                <tr data-tin="123456789" data-id-type="BRN" data-id-value="ABC123456">
                                                    <td class="outbound-checkbox-column">
                                                        <input type="checkbox" class="outbound-checkbox">
                                                    </td>
                                                    <td>1</td>
                                                    <td>INV-001</td>
                                                    <td>Company A</td>
                                                    <td>Supplier X</td>
                                                    <td>Receiver Y</td>
                                                    <td>2024-03-24</td>
                                                    <td>Regular</td>
                                                    <td class="status-cell">
                                                        <span class="badge bg-warning">Pending</span>
                                                    </td>
                                                    <td>LHDN</td>
                                                    <td>1,000.00</td>
                                                    <td class="outbound-action-column">
                                                        <div class="action-buttons">
                                                            <button class="btn btn-sm validate-tin-btn" data-validate-tin>
                                                                <i class="bi bi-shield-check"></i>
                                                                Validate TIN
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-primary">
                                                                <i class="bi bi-eye"></i>
                                                                View
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-danger">
                                                                <i class="bi bi-trash"></i>
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Loading Overlay -->
                        <div id="tableLoadingOverlay" class="table-loading-overlay d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Fetching documents...</p>
                        </div>
                    </div>
                    
                    
       
                    <div class="table-footer">
                        <div class="disclaimer-note mt-2" style="background: rgba(220, 53, 69, 0.1); color: #842029;">
                            <i class="bi bi-exclamation-triangle"></i>
                            <span><strong>Important Disclaimer:</strong> <br>
                            Our platform provides validation services, but the ultimate responsibility for data accuracy lies with the user. 
                            <br>
                            We are not liable for any consequences, penalties, or issues arising from submission of incomplete, inaccurate or non-compliant data to LHDN.</span>
                        </div>

<!-- Flat File Mapping Modal -->
<div class="modal fade" id="flatFileMappingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Configure Consolidated Invoice</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="mappingForm">
          <input type="hidden" id="mappingFileId">
          <input type="hidden" id="mappingFileUuid">
          
          <div class="mb-3">
            <label for="consolidationType" class="form-label">Consolidation Type</label>
            <select class="form-select" id="consolidationType" required>
              <option value="default">Standard Consolidation</option>
              <option value="custom">Custom Consolidation</option>
            </select>
            <div class="form-text">Choose how to consolidate your invoices</div>
          </div>
          
          <div id="customConsolidationFields" style="display: none;">
            <div class="mb-3">
              <label for="classificationCode" class="form-label">Classification Code</label>
              <select class="form-select" id="classificationCode">
                <option value="004">G4 - Goods</option>
                <option value="005">S1 - Services</option>
                <option value="006">S2 - Rental</option>
                <option value="007">S3 - Commission</option>
              </select>
              <div class="form-text">Select the classification code for this consolidated invoice</div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="consolidationStartDate" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="consolidationStartDate" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="consolidationEndDate" class="form-label">End Date</label>
                <input type="date" class="form-control" id="consolidationEndDate" required>
              </div>
            </div>
          </div>
          
          <!-- <div class="mb-3">
            <label for="consolidationNotes" class="form-label">Notes (Optional)</label>
            <textarea class="form-control" id="consolidationNotes" rows="3" placeholder="Enter additional information about this consolidated invoice"></textarea>
          </div> -->
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveMapping">Save Settings</button>
      </div>
    </div>
  </div>
</div>

<!-- Manual Consolidation Modal -->
<div class="modal fade manual-consolidation-modal" id="manualConsolidationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-light border-bottom">
        <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>Create Manual Consolidated e-Invoice</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Quick Guide -->
        <div class="alert alert-primary mb-4 shadow-sm">
          <div class="d-flex">
            <div class="flex-shrink-0">
              <i class="bi bi-lightbulb fs-4"></i>
            </div>
            <div class="ms-3">
              <h6 class="alert-heading mb-1">Quick Guide</h6>
              <p class="mb-0">Toggle <strong>Multiple Line Items Mode</strong> to switch between consolidated totals or itemized entries. Hover over fields for more information.</p>
              <p class="mb-0 text-primary"><i class="bi bi-info-circle me-1"></i>Buyer will be automatically set as "General Public" with TIN "EI00000000010" as required by LHDN.</p>
            </div>
          </div>
        </div>
        
        <form id="manualConsolidationForm">
          <!-- Mode Selection Section -->
          <div class="card shadow-sm mb-4">
            <div class="card-body p-0">
              <div class="row g-0">
                <!-- Multiple Line Items Toggle -->
                <div class="col-md-6 border-end">
                  <div class="mode-toggle p-4 h-100">
                    <div class="d-flex align-items-center mb-2">
                      <div class="mode-icon me-3">
                        <i class="bi bi-list-ul fs-4"></i>
                      </div>
                      <div class="flex-grow-1">
                        <h6 class="mb-0 d-flex align-items-center">
                          Multiple Line Items
                          <div class="form-check form-switch ms-2 mb-0">
                            <input class="form-check-input" type="checkbox" id="lineItemModeToggle" checked>
                          </div>
                        </h6>
                      </div>
                    </div>
                    <p class="text-muted mb-0 small">Toggle to switch between multiple line items and single consolidated entry</p>
                  </div>
                </div>

                <!-- Foreign Currency Toggle -->
                <div class="col-md-6">
                  <div class="mode-toggle p-4 h-100">
                    <div class="d-flex align-items-center mb-2">
                      <div class="mode-icon me-3">
                        <i class="bi bi-currency-exchange fs-4"></i>
                      </div>
                      <div class="flex-grow-1">
                        <h6 class="mb-0 d-flex align-items-center">
                          Foreign Currency (Optional)
                          <div class="form-check form-switch ms-2 mb-0">
                            <input class="form-check-input" type="checkbox" id="foreignCurrencyToggle">
                          </div>
                        </h6>
                      </div>
                    </div>
                    <p class="text-muted mb-0 small">Enable foreign currency options for non-MYR transactions mandatory if applicable</p>
                  </div>
                </div>
              </div>
            </div>
          </div>


          <!-- Top Section with Card Style -->
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <div class="row">
                <!-- Invoice Details Column -->
                <div class="col-md-6 border-end">
                  <h6 class="section-heading text-primary mb-3">
                    <i class="bi bi-file-text me-2"></i>Invoice Details
                  </h6>
                  <div class="mb-3">
                    <label for="manualInvoiceNo" class="form-label">Invoice Number</label>
                    <div class="input-group">
                      <span class="input-group-text bg-light"><i class="bi bi-hash"></i></span>
                      <input type="text" class="form-control" id="manualInvoiceNo" placeholder="CONS-YYYY-MM-001" required 
                             data-bs-toggle="tooltip" data-bs-placement="top" title="A unique identifier for this consolidated invoice">
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="manualStartDate" class="form-label">Period Start</label>
                        <div class="input-group">
                          <span class="input-group-text bg-light"><i class="bi bi-calendar-event"></i></span>
                          <input type="date" class="form-control" id="manualStartDate" required>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="manualEndDate" class="form-label">Period End</label>
                        <div class="input-group">
                          <span class="input-group-text bg-light"><i class="bi bi-calendar-event"></i></span>
                          <input type="date" class="form-control" id="manualEndDate" required>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="manualDescription" class="form-label">Invoice Description</label>
                    <textarea class="form-control" id="manualDescription" rows="2" 
                              placeholder="E.g., Consolidated sales for Jan 2025 (Invoice #1001-1500)" required
                              data-bs-toggle="tooltip" data-bs-placement="top" 
                              title="Brief description of what this consolidated invoice contains"></textarea>
                  </div>
                </div>

                <!-- Tax Configuration Column -->
                <div class="col-md-6">
                  <h6 class="section-heading text-primary mb-3">
                    <i class="bi bi-gear me-2"></i>Tax Configuration
                  </h6>
                  
                  <!-- Tax Settings -->
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="globalTaxType" class="form-label">Tax Type</label>
                        <select class="form-select" id="globalTaxType" required>
                          <option value="01">01 - Sales Tax</option>
                          <option value="02">02 - Service Tax</option>
                          <option value="03">03 - Tourism Tax</option>
                          <option value="06">06 - Not Applicable</option>
                          <option value="E">E - Tax Exemption</option>
                        </select>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="globalTaxRate" class="form-label">Tax Rate (%)</label>
                        <div class="input-group">
                          <input type="number" class="form-control" id="globalTaxRate" value="8" min="0" max="100" step="0.01" required>
                          <span class="input-group-text">%</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Classification (Disabled, always 004) -->
                  <div class="mb-3">
                    <label for="globalClassification" class="form-label">Classification</label>
                    <select class="form-select bg-light" id="globalClassification" disabled>
                      <option value="004">004</option>
                    </select>
                    <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Fixed as per IRBM requirements</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Line Items Section -->
          <div class="row mt-4" id="multipleLineItemsSection">
            <div class="col-12">
           
          <!-- Currency Settings Section (initially hidden) -->
          <div id="currencySettings" class="card shadow-sm mb-4 border-primary border-opacity-25 d-none">
            <div class="card-header bg-primary bg-opacity-10 border-primary border-opacity-25">
              <h6 class="mb-0 text-primary">
                <i class="bi bi-currency-exchange me-2"></i>Currency Settings (Optional)
              </h6>
            </div>
            <div class="card-body mt-2">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="globalCurrency" class="form-label">Document Currency</label>
                  <select class="form-select" id="globalCurrency" onchange="if(window.consolidationManager) { window.consolidationManager.handleCurrencyChange(); }">
                    <option value="MYR">MYR - Malaysian Ringgit</option>
                    <option value="USD">USD - US Dollar</option>
                    <option value="SGD">SGD - Singapore Dollar</option>
                    <option value="EUR">EUR - Euro</option>
                    <option value="GBP">GBP - British Pound</option>
                    <option value="JPY">JPY - Japanese Yen</option>
                    <option value="CNY">CNY - Chinese Yuan</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="globalExchangeRate" class="form-label">Exchange Rate</label>
                  <div class="input-group">
                    <input type="number" class="form-control" id="globalExchangeRate" step="0.0001" min="0" value="1.0000">
                    <span class="input-group-text">to MYR</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="section-heading text-primary mb-3">
                    <i class="bi bi-file-text me-2"></i>Line Items
                  </h6>
                <button type="button" class="btn btn-outline-primary" id="addLineItemBtn">
                  <i class="bi bi-plus-circle me-1"></i>Add Line Item
                </button>
              </div>

              <div class="table-responsive">
                <table class="table line-items-table" id="lineItemsTable">
                  <thead>
                    <tr>
                      <th style="width: 5%">#</th>
                      <th style="width: 30%">Description</th>
                      <th style="width: -10%">Classification</th>
                      <th style="width: 7.3%">Tax Type</th>
                      <th style="width: 10%">Amount (Excl. Tax)</th>
                      <th style="width: 10%">Tax Amount</th>
                      <th style="width: 10%">Total Amount</th>
                      <th style="width: 10%">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="lineItemsBody">
                    <!-- Line items will be added here -->
                  </tbody>
                </table>
              </div>
              
              <!-- Separate footer with better layout -->
              <div class="line-items-footer">
               
                <div class="invoice-totals">
                  <div class="total-item">
                    <span class="total-label">Total Excluding Tax:</span>
                    <span id="displayTotalExclTax" class="total-value">MYR 0.00</span>
                  </div>
                  <div class="total-item">
                    <span class="total-label">Total Tax Amount:</span>
                    <span id="displayTaxAmount" class="total-value">MYR 0.00</span>
                  </div>
                  <div class="total-item">
                    <span class="total-label">Total Including Tax:</span>
                    <span id="displayTotalInclTax" class="total-value highlighted">MYR 0.00</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
        
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="exportToExcelBtn">
                <i class="bi bi-file-excel me-1"></i> Export to Excel
            </button>
            <button type="button" class="btn btn-primary" id="saveManualConsolidation">Create & Submit</button>
          </div>
              </div>
            </div>
            
          </div>
          
        </form>
        
      </div>
      

{% endblock %}

{% block scripts %}
<script src="/assets/js/modules/consolidation.js"></script>
<script src="/assets/js/modules/excel/outbound-consolidate.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize the ConsolidationManager first
    if (typeof ConsolidationManager !== 'undefined') {
      window.consolidationManager = new ConsolidationManager();
    }

    // Initialize the invoice table
    if (typeof InvoiceTableManager !== 'undefined') {
      InvoiceTableManager.getInstance().initializeTable();
    }
    
    // Initialize manual consolidation modal events
    const createManualBtn = document.getElementById('createManualConsolidationBtn');
    const emptyStateCreateBtn = document.getElementById('emptyStateCreateBtn');
    const saveManualBtn = document.getElementById('saveManualConsolidation');
    const addLineItemBtn = document.getElementById('addLineItemBtn');
    const manualConsolidationModal = document.getElementById('manualConsolidationModal');
    const lineItemModeToggle = document.getElementById('lineItemModeToggle');
    const exportBtn = document.getElementById('exportToExcelBtn');

    // Initialize export button event listener
    if (exportBtn && window.consolidationManager) {
      exportBtn.addEventListener('click', (e) => {
        e.preventDefault();
        console.log('Export button clicked');
        window.consolidationManager.exportToExcel();
      });
    }
    
    // Load data from utility files
    loadClassificationCodes();
    loadTaxTypes();
    loadPaymentMethods();
    loadCurrencyCodes();
    
    // Function to populate classification code dropdowns
    async function loadClassificationCodes() {
      try {
        const response = await fetch('/api/utils/classification-codes');
        if (!response.ok) throw new Error('Failed to fetch classification codes');
        
        const classificationCodes = await response.json();
        
        // Get all classification dropdowns
        const classificationSelects = [
          document.getElementById('globalClassification'),
          document.getElementById('singleClassification'),
          document.getElementById('classificationCode') // in mapping modal
        ];
        
        // Populate each dropdown
        classificationSelects.forEach(select => {
          if (select) {
            // Clear existing options
            select.innerHTML = '';
            
            // Add options from the fetched data
            classificationCodes.forEach(code => {
              const option = document.createElement('option');
              option.value = code.value;
              option.textContent = code.label;
              select.appendChild(option);
            });
          }
        });
      } catch (error) {
        console.error('Error loading classification codes:', error);
      }
    }
    
    // Function to populate tax type dropdowns
    async function loadTaxTypes() {
      try {
        const response = await fetch('/api/utils/tax-types');
        if (!response.ok) throw new Error('Failed to fetch tax types');
        
        const taxTypes = await response.json();
        
        // Get all tax type dropdowns
        const taxTypeSelects = [
          document.getElementById('globalTaxType'),
          document.getElementById('singleTaxType')
        ];
        
        // Populate each dropdown
        taxTypeSelects.forEach(select => {
          if (select) {
            // Clear existing options
            select.innerHTML = '';
            
            // Add options from the fetched data
            taxTypes.forEach(type => {
              const option = document.createElement('option');
              option.value = type.value;
              option.textContent = type.label;
              select.appendChild(option);
            });
          }
        });
      } catch (error) {
        console.error('Error loading tax types:', error);
      }
    }
    
    // Function to populate payment method dropdowns
    async function loadPaymentMethods() {
      try {
        const response = await fetch('/api/utils/payment-methods');
        if (!response.ok) throw new Error('Failed to fetch payment methods');
        
        const paymentMethods = await response.json();
        
        // Get payment method dropdowns if they exist
        const paymentMethodSelect = document.getElementById('paymentMethod');
        
        if (paymentMethodSelect) {
          // Clear existing options
          paymentMethodSelect.innerHTML = '';
          
          // Add options from the fetched data
          paymentMethods.forEach(method => {
            const option = document.createElement('option');
            option.value = method.value;
            option.textContent = method.label;
            paymentMethodSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading payment methods:', error);
      }
    }
    
    // Function to populate currency dropdowns
    async function loadCurrencyCodes() {
      try {
        const response = await fetch('/api/utils/currency-codes');
        if (!response.ok) throw new Error('Failed to fetch currency codes');
        
        const currencyCodes = await response.json();
        
        // Get document currency dropdown
        const documentCurrencySelect = document.getElementById('globalCurrency');
        
        // Get tax currency dropdown
        const taxCurrencySelect = document.getElementById('globalTaxCurrency');
        
        // Populate document currency dropdown
        if (documentCurrencySelect) {
          // Clear existing options
          documentCurrencySelect.innerHTML = '';
          
          // Add options from the fetched data
          currencyCodes.forEach(code => {
            const option = document.createElement('option');
            option.value = code.Code;
            option.textContent = `${code.Code} - ${code.Currency}`;
            documentCurrencySelect.appendChild(option);
          });
          
          // Set MYR as default
          documentCurrencySelect.value = 'MYR';
        }
        
        // Populate tax currency dropdown with all currencies
        if (taxCurrencySelect) {
          // Clear existing options
          taxCurrencySelect.innerHTML = '';
          
          // Add all currencies to the tax currency dropdown
          currencyCodes.forEach(code => {
            const option = document.createElement('option');
            option.value = code.Code;
            option.textContent = `${code.Code} - ${code.Currency}`;
            taxCurrencySelect.appendChild(option);
          });
          
          // Set MYR as default
          taxCurrencySelect.value = 'MYR';
          
          // Initially disable the tax currency dropdown until foreign currency mode is enabled
          taxCurrencySelect.disabled = true;
        }
        
        // Initialize foreign currency toggle initial state
        const foreignCurrencyToggle = document.getElementById('foreignCurrencyToggle');
        if (foreignCurrencyToggle && window.consolidationManager) {
          // Check if foreign currency toggle is already initialized
          setTimeout(() => {
            if (typeof window.consolidationManager.handleForeignCurrencyToggle === 'function') {
              window.consolidationManager.handleForeignCurrencyToggle();
            }
          }, 300);
        } else {
          // Fallback if consolidationManager isn't initialized yet
          const currencyContainer = documentCurrencySelect?.closest('.col-md-2');
          const exchangeRateContainer = document.getElementById('globalExchangeRate')?.closest('.col-md-2');
          
          if (currencyContainer) currencyContainer.style.display = 'none';
          if (exchangeRateContainer) exchangeRateContainer.style.display = 'none';
        }
        
      } catch (error) {
        console.error('Error loading currency codes:', error);
      }
    }
    
    // Helper function to dynamically populate line item dropdowns when new items are added
    window.populateLineItemDropdowns = async function(row) {
      if (!row) return;
      
      try {
        // Get classification and tax type selects in this row
        const classificationSelect = row.querySelector('.item-classification');
        const taxTypeSelect = row.querySelector('.item-tax-type');
        
        if (classificationSelect) {
          const response = await fetch('/api/utils/classification-codes');
          if (response.ok) {
            const classificationCodes = await response.json();
            
            // Clear existing options
            classificationSelect.innerHTML = '';
            
            // Add options from the fetched data
            classificationCodes.forEach(code => {
              const option = document.createElement('option');
              option.value = code.value;
              option.textContent = code.label;
              classificationSelect.appendChild(option);
            });
            
            // Set default value to match global setting
            const globalClassification = document.getElementById('globalClassification');
            if (globalClassification && globalClassification.value) {
              classificationSelect.value = globalClassification.value;
            }
          }
        }
        
        if (taxTypeSelect) {
          const response = await fetch('/api/utils/tax-types');
          if (response.ok) {
            const taxTypes = await response.json();
            
            // Clear existing options
            taxTypeSelect.innerHTML = '';
            
            // Add options from the fetched data
            taxTypes.forEach(type => {
              const option = document.createElement('option');
              option.value = type.value;
              option.textContent = type.label;
              taxTypeSelect.appendChild(option);
            });
            
            // Set default value to match global setting
            const globalTaxType = document.getElementById('globalTaxType');
            if (globalTaxType && globalTaxType.value) {
              taxTypeSelect.value = globalTaxType.value;
            }
          }
        }
      } catch (error) {
        console.error('Error populating line item dropdowns:', error);
      }
    };
    
    // Fields to toggle visibility based on mode
    const manualTransactionsField = document.getElementById('manualTransactions')?.closest('.mb-3');
    const manualInvoiceRangeField = document.getElementById('manualInvoiceRange')?.closest('.mb-3');
    const manualDescriptionField = document.getElementById('manualDescription')?.closest('.mb-3');
    
    // Function to handle mode toggle
    if (lineItemModeToggle) {
      lineItemModeToggle.addEventListener('change', function() {
        const isMultipleMode = this.checked;
        
        // Control visibility of fields
        if (manualTransactionsField) manualTransactionsField.style.display = isMultipleMode ? 'none' : 'block';
        if (manualInvoiceRangeField) manualInvoiceRangeField.style.display = isMultipleMode ? 'none' : 'block';
        if (manualDescriptionField) manualDescriptionField.style.display = isMultipleMode ? 'none' : 'block';
        
        // In single mode, limit to one line item
        const lineItems = document.querySelectorAll('#lineItemsBody tr');
        
        // Keep only the first row in single mode, remove others
        if (!isMultipleMode && lineItems.length > 1) {
          for (let i = 1; i < lineItems.length; i++) {
            lineItems[i].remove();
          }
        }
        
        // Disable/enable "Add Line Item" button
        if (addLineItemBtn) {
          addLineItemBtn.disabled = !isMultipleMode;
          addLineItemBtn.classList.toggle('disabled', !isMultipleMode);
        }
        
        // Show toast message about the mode change
        showToast(
          isMultipleMode ? 
          'Multiple line items mode activated. You can now add individual items.' : 
          'Single consolidated entry mode activated.',
          'info',
          3000
        );
      });
    }
    
    // Initialize first line item when modal is shown
    if (manualConsolidationModal) {
      manualConsolidationModal.addEventListener('shown.bs.modal', () => {
        console.log('Modal shown, calculating first line item');
        
        // Set initial state of toggle fields
        if (lineItemModeToggle) {
          const isMultipleMode = lineItemModeToggle.checked;
          if (manualTransactionsField) manualTransactionsField.style.display = isMultipleMode ? 'none' : 'block';
          if (manualInvoiceRangeField) manualInvoiceRangeField.style.display = isMultipleMode ? 'none' : 'block';
          if (manualDescriptionField) manualDescriptionField.style.display = isMultipleMode ? 'none' : 'block';
          
          // Disable/enable "Add Line Item" button on initial load
          if (addLineItemBtn) {
            addLineItemBtn.disabled = !isMultipleMode;
            addLineItemBtn.classList.toggle('disabled', !isMultipleMode);
          }
          
          // Check if we need to add an initial line item
          if (isMultipleMode) {
            const lineItems = document.querySelectorAll('#lineItemsBody tr');
            if (lineItems.length === 0 && window.consolidationManager) {
              // Add the first line item automatically
              window.consolidationManager.addLineItem();
              
              // If there's a description entered, copy it to the new line item
              const description = document.getElementById('manualDescription')?.value || '';
              if (description.trim()) {
                setTimeout(() => {
                  const firstLineItemDescription = document.querySelector('#lineItemsBody tr:first-child .item-description');
                  if (firstLineItemDescription) {
                    firstLineItemDescription.value = description.trim();
                  }
                }, 100);
              }
            }
          }
          
          // Force immediate calculation of first line item
          const firstRow = document.querySelector('#lineItemsBody tr:first-child');
          if (firstRow && window.consolidationManager) {
            // Add a small delay to ensure all inputs are properly initialized
            setTimeout(() => {
              window.consolidationManager.calculateLineItemTotals(firstRow);
              window.consolidationManager.updateGrandTotals();
              
              // Also force sync the tax settings to ensure they are applied
              window.consolidationManager.forceSyncAllLineItems();
            }, 300);
          }
        }
      });
    }
    
    if (createManualBtn) {
      createManualBtn.addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('manualConsolidationModal'));
        modal.show();
      });
    }
    
    if (emptyStateCreateBtn) {
      emptyStateCreateBtn.addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('manualConsolidationModal'));
        modal.show();
      });
    }
    
    if (emptyStateUploadBtn) {
      emptyStateUploadBtn.addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('flatFileUploadModal'));
        modal.show();
      });
    }
    
    // Direct event listener for Add Line Item button
    if (addLineItemBtn) {
      console.log("Adding direct event listener to Add Line Item button");
      addLineItemBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log("Add Line Item button clicked directly");
        if (window.consolidationManager) {
          const newRow = window.consolidationManager.addLineItem();
          // Populate the dropdowns in the new row
          window.populateLineItemDropdowns(newRow);
          showToast('Line item added successfully', 'success', 2000);
        } else {
          console.error("consolidationManager not found");
        }
      });
    }
    
    // Direct event listeners for delete buttons
    document.getElementById('lineItemsBody').addEventListener('click', function(e) {
      const deleteBtn = e.target.closest('.remove-line-item');
      if (deleteBtn) {
        e.preventDefault();
        console.log("Delete button clicked");
        const row = deleteBtn.closest('tr');
        if (window.consolidationManager) {
          window.consolidationManager.removeLineItem(row);
          showToast('Line item removed', 'info', 2000);
        } else {
          console.error("consolidationManager not found");
        }
      }
    });
    
    // Auto-generate invoice number based on date
    const generateInvoiceNumber = () => {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const random = Math.floor(Math.random() * 900) + 100; // Random 3-digit number
      return `CONS-${year}-${month}-${random}`;
    };
    
    // Set invoice number field with auto-generated value
    const invoiceNoField = document.getElementById('manualInvoiceNo');
    if (invoiceNoField && !invoiceNoField.value) {
      invoiceNoField.value = generateInvoiceNumber();
    }
    
    // Set default dates for manual consolidation
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    const manualStartDate = document.getElementById('manualStartDate');
    const manualEndDate = document.getElementById('manualEndDate');
    
    if (manualStartDate) {
      manualStartDate.valueAsDate = firstDay;
    }
    
    if (manualEndDate) {
      manualEndDate.valueAsDate = lastDay;
    }
    
    // Auto-calculate tax amounts
    const totalExclTax = document.getElementById('manualTotalExclTax');
    const taxAmount = document.getElementById('manualTaxAmount');
    const totalInclTax = document.getElementById('manualTotalInclTax');
    const taxRate = document.getElementById('manualTaxRate');
    
    if (totalExclTax && taxAmount && totalInclTax && taxRate) {
      totalExclTax.addEventListener('input', updateTaxCalculations);
      taxRate.addEventListener('input', updateTaxCalculations);
    }
    
    function updateTaxCalculations() {
      const amount = parseFloat(totalExclTax.value) || 0;
      const rate = parseFloat(taxRate.value) || 0;
      
      const tax = amount * (rate / 100);
      const total = amount + tax;
      
      taxAmount.value = tax.toFixed(2);
      totalInclTax.value = total.toFixed(2);
    }
    
    // Handle manual consolidation form submission
    if (saveManualBtn) {
      saveManualBtn.addEventListener('click', async () => {
        const form = document.getElementById('manualConsolidationForm');
        
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        
        const data = {
          invoice_no: document.getElementById('manualInvoiceNo').value,
          start_date: document.getElementById('manualStartDate').value,
          end_date: document.getElementById('manualEndDate').value,
          description: document.getElementById('manualDescription').value,
          classification: document.getElementById('manualClassification').value,
          tax_type: document.getElementById('manualTaxType').value,
          tax_rate: document.getElementById('manualTaxRate').value,
          total_excl_tax: document.getElementById('manualTotalExclTax').value,
          tax_amount: document.getElementById('manualTaxAmount').value,
          total_incl_tax: document.getElementById('manualTotalInclTax').value,
          transactions: document.getElementById('manualTransactions').value,
          invoice_range: document.getElementById('manualInvoiceRange').value,
          notes: document.getElementById('manualNotes').value
        };
        
        try {
          consolidationManager.showLoadingState('Creating consolidated invoice...');
          
          const response = await fetch('/api/consolidation/create-manual', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
          
          consolidationManager.hideLoadingState();
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to create consolidated invoice');
          }
          
          const responseData = await response.json();
          
          // Close the modal
          const modal = bootstrap.Modal.getInstance(document.getElementById('manualConsolidationModal'));
          if (modal) modal.hide();
          
          // Show success message
          showToast('Consolidated invoice created successfully!', 'success', 4000);
          
          // Refresh the table
          if (typeof InvoiceTableManager !== 'undefined' && InvoiceTableManager.getInstance) {
            InvoiceTableManager.getInstance().refresh(true);
          }
        } catch (error) {
          consolidationManager.hideLoadingState();
          showToast('Error creating consolidated invoice: ' + error.message, 'error', 5000);
        }
      });
    }

    // Auto-populate line item descriptions from Invoice Description
    const manualDescription = document.getElementById('manualDescription');
    if (manualDescription) {
      manualDescription.addEventListener('input', function() {
        const description = this.value.trim();
        
        // Update single line item description
        const singleDescription = document.getElementById('singleDescription');
        if (singleDescription) {
          singleDescription.value = description;
        }
        
        // Update first line item description
        const firstLineItemDescription = document.querySelector('#lineItemsBody tr:first-child .item-description');
        if (firstLineItemDescription) {
          firstLineItemDescription.value = description;
        }
        
        // If there are no line items yet and in multiple mode, add one with this description
        const isMultipleMode = lineItemModeToggle ? lineItemModeToggle.checked : false;
        const lineItems = document.querySelectorAll('#lineItemsBody tr');
        if (isMultipleMode && lineItems.length === 0 && window.consolidationManager && description) {
          const newRow = window.consolidationManager.addLineItem();
          const descInput = newRow.querySelector('.item-description');
          if (descInput) {
            descInput.value = description;
          }
        }
      });
    }
    
    // Initialize tooltips
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl, {
      container: 'body',
      trigger: 'hover',
      html: true
    }));
    
    // Enhanced toast system
    const showToast = (message, type = 'success', duration = 3000) => {
      // Remove any existing toasts
      const existingToasts = document.querySelectorAll('.toast-container');
      existingToasts.forEach(toast => toast.remove());
      
      // Create toast container if it doesn't exist
      let toastContainer = document.querySelector('.toast-container');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
      }
      
      // Create the toast element
      const toastEl = document.createElement('div');
      toastEl.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'error' ? 'exclamation-circle' : 'info-circle'} border-0`;
      toastEl.setAttribute('role', 'alert');
      toastEl.setAttribute('aria-live', 'assertive');
      toastEl.setAttribute('aria-atomic', 'true');
      
      // Create toast content
      toastEl.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      `;
      
      // Add the toast to the container
      toastContainer.appendChild(toastEl);
      
      // Initialize and show the toast
      const toast = new bootstrap.Toast(toastEl, {
        autohide: true,
        delay: duration
      });
      
      toast.show();
      
      // Remove the toast after it's hidden
      toastEl.addEventListener('hidden.bs.toast', () => {
        toastEl.remove();
      });
    };

    // Add this to your existing JavaScript
    document.addEventListener('DOMContentLoaded', function() {
      const foreignCurrencyToggle = document.getElementById('foreignCurrencyToggle');
      const currencySettings = document.getElementById('currencySettings');
      const documentCurrencySelect = document.getElementById('globalCurrency');
      
      // Initialize currency settings visibility
      if (foreignCurrencyToggle && currencySettings) {
        foreignCurrencyToggle.addEventListener('change', function() {
          if (this.checked) {
            currencySettings.style.opacity = '0';
            currencySettings.classList.remove('d-none');
            setTimeout(() => {
              currencySettings.style.opacity = '1';
            }, 50);
          } else {
            currencySettings.classList.add('d-none');
          }
        });
      }

      // Load currencies immediately if they're hardcoded
      if (documentCurrencySelect) {
        // Set default to MYR
        documentCurrencySelect.value = 'MYR';
        
        // Trigger change event to update any dependent fields
        const event = new Event('change');
        documentCurrencySelect.dispatchEvent(event);
      }
    });
  });
</script>

<style>
.mode-toggle {
  transition: background-color 0.2s ease;
}

.mode-toggle:hover {
  background-color: rgba(13, 110, 253, 0.03);
}

.mode-icon {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  background-color: rgba(13, 110, 253, 0.1);
  color: #0d6efd;
}

.form-check-input {
  height: 1.25rem;
  width: 2.25rem;
  cursor: pointer;
  margin-top: 0;
}

.form-check-input:checked {
  background-color: #0d6efd;
  border-color: #0d6efd;
}

.form-check-input:focus {
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Professional toggle animation */
.form-check-input {
  transition: background-position 0.15s ease-in-out, 
              background-color 0.15s ease-in-out,
              border-color 0.15s ease-in-out,
              box-shadow 0.15s ease-in-out;
}

.mode-icon i {
  transition: transform 0.2s ease;
}

.mode-toggle:hover .mode-icon i {
  transform: scale(1.1);
}
</style>
{% endblock %}